# Workflow редактирования онтологии в FEONT

**Дата создания:** 2026-01-01  
**Версия:** 1.0.0  
**Статус:** Актуальная

---

## Обзор

Данный документ описывает процесс редактирования онтологии FEONT с использованием внешних инструментов (например, Protege Desktop). Workflow основан на экспорте онтологии из приложения, редактировании в Protege Desktop, и последующем импорте изменений обратно в приложение.

**Важно:** Во время редактирования онтологии рекомендуется приостановить работу с приложением, чтобы избежать конфликтов данных. Для небольших команд это приемлемый подход.

---

## Предварительные требования

1. **Запущенное приложение FEONT**
   - Backend должен быть доступен (по умолчанию: `http://localhost:8083`)
   - Данные TDB2 должны быть инициализированы

2. **Protege Desktop** (или другой RDF редактор)
   - Protege Desktop можно скачать с [https://protege.stanford.edu/](https://protege.stanford.edu/)
   - Рекомендуется версия 5.6.3 или новее

3. **Инструменты для работы с файлами**
   - `curl` для экспорта/импорта через командную строку
   - Или веб-браузер для экспорта
   - Или Postman/другие HTTP клиенты

---

## Шаг 1: Экспорт онтологии

Экспорт онтологии из графа `urn:ontology` в формате Turtle.

### Способ 1: Через командную строку (curl)

```bash
curl -o ontology.ttl http://localhost:8083/ds/ontology
```

Где:
- `ontology.ttl` - имя файла для сохранения
- `http://localhost:8083/ds/ontology` - endpoint экспорта

### Способ 2: Через браузер

Откройте в браузере:
```
http://localhost:8083/ds/ontology
```

Сохраните страницу как файл с расширением `.ttl` (например, `ontology.ttl`).

### Способ 3: Через Protege Desktop

1. Запустите Protege Desktop
2. Выберите `File → Open from URL...`
3. Введите URL: `http://localhost:8083/ds/ontology`
4. Нажмите `Open`
5. После загрузки сохраните файл локально: `File → Save As...`

### Результат

После экспорта у вас будет файл `ontology.ttl` в формате Turtle, содержащий все классы, свойства и их определения из графа `urn:ontology`.

**Формат данных:** Turtle (`.ttl`) - текстовый формат RDF, легко читается и редактируется.

---

## Шаг 2: Резервное копирование (бэкап)

**Важно:** Перед редактированием онтологии рекомендуется сделать резервную копию данных TDB2.

### Бэкап TDB2 хранилища

1. Остановите приложение (если запущено):
   ```bash
   pkill -f "feont-1.0.0-SNAPSHOT.jar"
   ```

2. Скопируйте директорию TDB2:
   ```bash
   cp -r /path/to/feont/code/data/tdb2 /path/to/backup/tdb2-backup-$(date +%Y%m%d-%H%M%S)
   ```

   Или на сервере (если приложение развёрнуто):
   ```bash
   cp -r /home/user1/feont/data/tdb2 /home/user1/feont/backups/tdb2-backup-$(date +%Y%m%d-%H%M%S)
   ```

3. Сохраните экспортированный файл онтологии:
   ```bash
   cp ontology.ttl ontology-backup-$(date +%Y%m%d-%H%M%S).ttl
   ```

**Рекомендация:** Создавайте бэкапы перед каждым циклом редактирования онтологии.

---

## Шаг 3: Редактирование онтологии в Protege Desktop

### Открытие файла

1. Запустите Protege Desktop
2. Выберите `File → Open...`
3. Выберите файл `ontology.ttl`, сохранённый на Шаге 1

### Рекомендации по редактированию

1. **Добавление классов:**
   - Используйте вкладку `Entities → Classes`
   - Создайте новый класс, указав IRI (например, `https://feont.ontoline.ru/ontology/NewClass`)
   - Добавьте метки (`rdfs:label`) и комментарии (`rdfs:comment`)

2. **Добавление свойств:**
   - Используйте вкладку `Entities → Object Properties` или `Data Properties`
   - Укажите domain и range для свойств
   - Добавьте метки и комментарии

3. **Изменение существующих элементов:**
   - Найдите класс или свойство в соответствующих вкладках
   - Измените необходимые атрибуты
   - Protege автоматически обновит файл

### Сохранение изменений

1. Выберите `File → Save` (или `File → Save As...` для сохранения под новым именем)
2. Убедитесь, что файл сохранён в формате Turtle (`.ttl`)

**Важно:** 
- Сохраняйте файл в формате Turtle (`.ttl`)
- Не изменяйте базовый URI префикса `feont:` без необходимости
- Проверьте корректность синтаксиса перед сохранением

---

## Шаг 4: Импорт изменённой онтологии

После редактирования и сохранения файла в Protege Desktop, необходимо импортировать изменения обратно в приложение.

### Рекомендация: Остановка приложения

Перед импортом рекомендуется остановить приложение, чтобы избежать конфликтов:

```bash
pkill -f "feont-1.0.0-SNAPSHOT.jar"
```

После импорта приложение можно будет запустить заново.

### Способ 1: Через командную строку (curl)

```bash
curl -X POST \
  -F "file=@ontology.ttl" \
  -F "format=turtle" \
  http://localhost:8083/ds/ontology/import
```

Где:
- `ontology.ttl` - путь к отредактированному файлу
- `format=turtle` - формат файла (turtle, rdf, xml, jsonld)
- `http://localhost:8083/ds/ontology/import` - endpoint импорта

### Способ 2: Через Postman

1. Создайте новый POST запрос
2. URL: `http://localhost:8083/ds/ontology/import`
3. Body → form-data:
   - Ключ: `file`, Тип: File, Значение: выберите файл `ontology.ttl`
   - Ключ: `format`, Тип: Text, Значение: `turtle`
4. Отправьте запрос

### Способ 3: Через веб-интерфейс (будущая функциональность)

В будущем планируется добавление веб-интерфейса для импорта через браузер.

### Ответ сервера

При успешном импорте сервер вернёт JSON:

```json
{
  "status": "success",
  "message": "Онтология успешно импортирована",
  "triples": 15,
  "filename": "ontology.ttl",
  "format": "turtle"
}
```

Где `triples` - количество загруженных триплетов (RDF утверждений).

При ошибке будет возвращён JSON с полем `error`:

```json
{
  "status": "error",
  "error": "Описание ошибки"
}
```

### Запуск приложения после импорта

После успешного импорта запустите приложение:

```bash
cd /path/to/feont
java -Dorg.springframework.boot.logging.LoggingSystem=none \
  -jar code/backend/target/feont-1.0.0-SNAPSHOT.jar \
  --spring.profiles.active=dev \
  --feont.tdb2.path=./code/data/tdb2 \
  --server.port=8083
```

---

## Шаг 5: Проверка изменений

После импорта и запуска приложения проверьте, что изменения корректно загружены:

### Проверка через экспорт

```bash
curl http://localhost:8083/ds/ontology | grep "NewClass"
```

(Замените `NewClass` на имя вашего нового класса или свойства)

### Проверка через SPARQL запрос

Выполните SPARQL запрос через веб-интерфейс приложения или через curl:

```bash
curl -X POST \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "query=SELECT * WHERE { GRAPH <urn:ontology> { ?s ?p ?o } } LIMIT 10" \
  http://localhost:8083/ds/sparql
```

### Проверка через визуализацию

Откройте в браузере страницу визуализации графа (если доступна) и проверьте, что новые классы и свойства отображаются корректно.

---

## Поддерживаемые форматы файлов

Endpoint импорта поддерживает следующие форматы RDF:

1. **Turtle (`.ttl`)** - рекомендуется
   - Формат: `turtle` или `ttl`
   - Легко читается и редактируется
   - Поддерживается Protege Desktop

2. **RDF/XML (`.rdf`, `.xml`)**
   - Формат: `rdf`, `xml`, или `rdf/xml`
   - Стандартный XML формат RDF

3. **JSON-LD (`.jsonld`, `.json`)**
   - Формат: `json`, `jsonld`, или `json-ld`
   - JSON представление RDF

4. **N3 (`.n3`)**
   - Формат: `n3`
   - Расширение Turtle

5. **N-Triples (`.nt`)**
   - Формат: `ntriples` или `nt`
   - Построчное представление триплетов

**Рекомендация:** Используйте формат Turtle (`.ttl`) для работы с Protege Desktop, так как он наиболее удобен для чтения и редактирования.

---

## Важные замечания

### Безопасность данных

1. **Всегда создавайте бэкапы** перед редактированием онтологии
2. **Останавливайте приложение** перед импортом изменений
3. **Проверяйте изменения** после импорта перед продолжением работы

### Производительность

- Импорт заменяет **все** данные в графе `urn:ontology`
- При большом объёме данных процесс может занять время
- Рекомендуется тестировать изменения на небольших файлах

### Ограничения

- Endpoint импорта **не проверяет** корректность онтологии (синтаксис RDF проверяется, но семантика OWL не валидируется)
- После импорта рекомендуется проверить целостность данных
- Другие Named Graphs (`urn:data`, `urn:shacl:shapes` и т.д.) **не затрагиваются** импортом

### Синхронизация

- Если приложение работает во время редактирования файла, после импорта изменения, сделанные через интерфейс приложения, будут **перезаписаны**
- Рекомендуется приостанавливать работу с приложением на время редактирования онтологии

---

## Troubleshooting

### Ошибка: "Failed to connect to localhost port 8083"

**Причина:** Приложение не запущено или недоступно.

**Решение:**
1. Проверьте, запущено ли приложение: `ps aux | grep feont`
2. Проверьте логи: `tail -f /tmp/feont-app.log`
3. Запустите приложение заново

### Ошибка импорта: "Ошибка замены данных"

**Причина:** Неправильный формат файла или синтаксическая ошибка в RDF.

**Решение:**
1. Проверьте формат файла (должен быть корректный Turtle/RDF/XML)
2. Проверьте синтаксис через валидатор RDF (например, онлайн-валидатор)
3. Попробуйте открыть файл в Protege Desktop и сохранить заново

### Данные не загрузились после импорта

**Причина:** Возможно, транзакция не была закоммичена из-за ошибки.

**Решение:**
1. Проверьте логи приложения на наличие ошибок
2. Проверьте ответ endpoint импорта (должен содержать `"status": "success"`)
3. Попробуйте импортировать файл заново

### Блокировка TDB2 (lock file)

**Причина:** Предыдущий процесс не завершился корректно, оставив блокировку.

**Решение:**
1. Убедитесь, что все процессы приложения остановлены: `pkill -f feont`
2. Удалите файл блокировки: `rm code/data/tdb2/tdb.lock`
3. Запустите приложение заново

---

## Пример полного workflow

```bash
# 1. Экспорт онтологии
curl -o ontology.ttl http://localhost:8083/ds/ontology

# 2. Бэкап
cp -r code/data/tdb2 code/data/tdb2-backup-$(date +%Y%m%d-%H%M%S)
cp ontology.ttl ontology-backup-$(date +%Y%m%d-%H%M%S).ttl

# 3. Редактирование в Protege Desktop (вручную)
# ... открыть ontology.ttl в Protege, внести изменения, сохранить ...

# 4. Остановка приложения
pkill -f "feont-1.0.0-SNAPSHOT.jar"

# 5. Импорт изменений
curl -X POST \
  -F "file=@ontology.ttl" \
  -F "format=turtle" \
  http://localhost:8083/ds/ontology/import

# 6. Запуск приложения
java -Dorg.springframework.boot.logging.LoggingSystem=none \
  -jar code/backend/target/feont-1.0.0-SNAPSHOT.jar \
  --spring.profiles.active=dev \
  --feont.tdb2.path=./code/data/tdb2 \
  --server.port=8083 > /tmp/feont-app.log 2>&1 &

# 7. Проверка
sleep 5
curl http://localhost:8083/ds/ontology | grep "YourNewClass"
```

---

## Связанные документы

- [`docs/development/notes/docs-preliminary/25-1231-ontology-editing-workflow-selection.md`](../development/notes/docs-preliminary/25-1231-ontology-editing-workflow-selection.md) - выбор workflow и анализ альтернатив
- [`docs/project/project-docs.json`](../project/project-docs.json) - документация проекта
- [Protege Desktop Documentation](https://protege.stanford.edu/help/) - документация Protege

---

**Последнее обновление:** 2026-01-01


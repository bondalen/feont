# Скрипты развёртывания FEONT

Набор скриптов для автоматизации развёртывания приложения FEONT на сервере.

## Описание скриптов

### 1. `prepare-server.sh` - Подготовка сервера

Подготавливает сервер для развёртывания: создаёт структуру каталогов, проверяет Java.

**Использование:**
```bash
./scripts/prepare-server.sh user1@176.108.244.252
```

**Что делает:**
- Создаёт структуру каталогов: `/home/user1/feont/`, `/home/user1/feont/data/tdb2/`, `/home/user1/feont/logs/`, `/home/user1/feont/config/`
- Проверяет наличие Java
- Проверяет место на диске

### 2. `build.sh` - Сборка проекта

Собирает frontend и backend в единый JAR файл.

**Использование:**
```bash
./scripts/build.sh          # Сборка backend и frontend
./scripts/build.sh backend  # Только backend
./scripts/build.sh frontend # Только frontend
```

**Что делает:**
- Собирает frontend в `frontend/dist/spa/`
- Копирует frontend статику в `backend/src/main/resources/static/`
- Собирает JAR файл: `backend/target/feont-1.0.0-SNAPSHOT.jar`

### 3. `setup-systemd.sh` - Настройка systemd service

Настраивает systemd service для автозапуска приложения.

**Использование:**
```bash
./scripts/setup-systemd.sh user1@176.108.244.252
```

**Что делает:**
- Копирует service файл на сервер: `/etc/systemd/system/feont.service`
- Перезагружает systemd
- Включает автозапуск: `systemctl enable feont`

**После настройки:**
```bash
# Запуск
ssh user1@176.108.244.252 "sudo systemctl start feont"

# Остановка
ssh user1@176.108.244.252 "sudo systemctl stop feont"

# Статус
ssh user1@176.108.244.252 "sudo systemctl status feont"

# Логи
ssh user1@176.108.244.252 "sudo journalctl -u feont -f"
```

### 4. `setup-nginx.sh` - Настройка Nginx

Настраивает Nginx reverse proxy для приложения.

**Использование:**
```bash
./scripts/setup-nginx.sh user1@176.108.244.252
```

**Что делает:**
- Копирует конфигурацию на сервер: `/etc/nginx/sites-available/feont`
- Создаёт символическую ссылку в `sites-enabled/`
- Проверяет конфигурацию: `nginx -t`
- Перезагружает Nginx: `systemctl reload nginx`

**Настройка:**
- По умолчанию настроен HTTP (порт 80)
- Для HTTPS раскомментируйте секцию HTTPS в `nginx-feont.conf`
- Домен: `feont.ontoline.ru` (можно изменить)

### 5. `deploy.sh` - Развёртывание приложения

Развёртывает собранный JAR файл на сервере.

**Использование:**
```bash
./scripts/deploy.sh user1@176.108.244.252 [jar_path]
```

**Что делает:**
- Подготавливает структуру каталогов на сервере
- Копирует JAR файл на сервер
- Копирует systemd service файл (если существует)
- Перезагружает systemd

### 6. `update.sh` - Обновление приложения

Обновляет приложение на сервере с сохранением резервной копии.

**Использование:**
```bash
./scripts/update.sh user1@176.108.244.252 [new_jar_path]
```

**Что делает:**
- Останавливает приложение
- Создаёт резервную копию текущей версии
- Копирует новый JAR файл
- Запускает приложение
- Проверяет статус

**Откат при проблемах:**
```bash
ssh user1@176.108.244.252 "cd /home/user1/feont && \
  mv feont-1.0.0.jar.backup-* feont-1.0.0.jar && \
  sudo systemctl restart feont"
```

### 7. `test-local.sh` - Локальное тестирование

Запускает и тестирует приложение локально перед развёртыванием.

**Использование:**
```bash
./scripts/test-local.sh [jar_path]
```

**Что делает:**
- Проверяет наличие JAR файла
- Проверяет доступность порта 8083
- Запускает приложение в dev режиме
- Автоматически проверяет health check и SPARQL endpoints
- Позволяет тестировать функциональность локально

**Прерывание:** Нажмите Ctrl+C для остановки приложения.

### 8. `check-build.sh` - Проверка результатов сборки

Проверяет результаты сборки: размер JAR, наличие frontend статики, содержимое.

**Использование:**
```bash
./scripts/check-build.sh
```

**Что делает:**
- Проверяет наличие и размер JAR файла
- Проверяет наличие frontend сборки
- Проверяет, что статика скопирована в backend
- Проверяет содержимое JAR файла (если доступен unzip)

### 9. `full-deploy.sh` - Полное развёртывание

Выполняет полный цикл: подготовка, сборка, тестирование, развёртывание.

**Использование:**
```bash
./scripts/full-deploy.sh user1@176.108.244.252 [--no-build] [--no-test]
```

**Опции:**
- `--no-build` - пропустить сборку (использовать существующий JAR)
- `--no-test` - пропустить локальное тестирование

**Что делает:**
1. Подготовка сервера (prepare-server.sh)
2. Сборка проекта (build.sh) - если не пропущена
3. Проверка результатов - если не пропущена
4. Настройка systemd (если не настроен)
5. Настройка Nginx (если не настроен)
6. Развёртывание (deploy.sh)
7. Запуск приложения
8. Проверка статуса

## Полный процесс развёртывания

### Вариант 1: Автоматическое развёртывание (рекомендуется)

**Одной командой:**
```bash
./scripts/full-deploy.sh user1@176.108.244.252
```

Этот скрипт автоматически выполнит все необходимые шаги.

### Вариант 2: Пошаговое развёртывание

**Первое развёртывание:**

1. **Проверка сборки (опционально):**
   ```bash
   ./scripts/build.sh
   ./scripts/check-build.sh
   ```

2. **Локальное тестирование (рекомендуется):**
   ```bash
   ./scripts/test-local.sh
   ```

3. **Полное развёртывание:**
   ```bash
   ./scripts/full-deploy.sh user1@176.108.244.252
   ```

   Или вручную:
   ```bash
   ./scripts/prepare-server.sh user1@176.108.244.252
   ./scripts/setup-systemd.sh user1@176.108.244.252
   ./scripts/setup-nginx.sh user1@176.108.244.252
   ./scripts/deploy.sh user1@176.108.244.252
   ssh user1@176.108.244.252 "sudo systemctl start feont"
   ```

### Обновление приложения:

**Вариант 1: Автоматическое обновление**
```bash
./scripts/build.sh
./scripts/update.sh user1@176.108.244.252
```

**Вариант 2: Полное развёртывание с пропуском тестирования**
```bash
./scripts/full-deploy.sh user1@176.108.244.252 --no-test
```

## Структура на сервере

```
/home/user1/feont/
├── feont-1.0.0.jar          # JAR файл приложения
├── feont-1.0.0.jar.backup-* # Резервные копии
├── data/
│   └── tdb2/                # TDB2 хранилище (данные сохраняются здесь)
├── logs/                    # Логи приложения (опционально)
└── config/                  # Конфигурационные файлы (опционально)
```

## Важные замечания

1. **Данные сохраняются** в `/home/user1/feont/data/tdb2/` - при обновлении JAR данные остаются нетронутыми.

2. **Права доступа:** Скрипты используют пользователя `user1`. Убедитесь, что у пользователя есть права для создания каталогов.

3. **Systemd и Nginx:** Некоторые операции требуют прав sudo. Убедитесь, что пользователь имеет соответствующие права.

4. **Порты:**
   - Backend работает на порту 8083
   - Nginx проксирует на 8083
   - Убедитесь, что порт 8083 не занят другими приложениями

5. **Переменные окружения:**
   - `FEONT_TDB2_PATH` - путь к TDB2 хранилищу (по умолчанию: `/home/user1/feont/data/tdb2`)
   - `JAVA_OPTS` - опции JVM (по умолчанию: `-Xmx1G -Xms512M`)

## Проверка развёртывания

```bash
# Проверка статуса приложения
ssh user1@176.108.244.252 "sudo systemctl status feont"

# Проверка доступности
curl http://176.108.244.252/health

# Проверка SPARQL endpoint
curl http://176.108.244.252/ds/ping

# Просмотр логов
ssh user1@176.108.244.252 "sudo journalctl -u feont -f"
```

